import socket
import requests
import json
import time
import sys
from urllib.parse import urlparse

# ðŸ’€ PENTEST LITE 1000X - SECURITY SCANNER
# Autor: Huzeneger Omni-OS

COMMON_PORTS = {
    21: "FTP", 22: "SSH", 23: "TELNET", 25: "SMTP", 
    53: "DNS", 80: "HTTP", 443: "HTTPS", 3306: "MYSQL",
    5432: "POSTGRES", 8080: "PROXY/JAVA", 27017: "MONGODB"
}

SECURITY_HEADERS = [
    "Content-Security-Policy",
    "X-Frame-Options",
    "X-Content-Type-Options",
    "Strict-Transport-Security",
    "Referrer-Policy"
]

def scan_security(target):
    print(f"ðŸ’€ [PENTEST] INICIANDO RECONOCIMIENTO SOBRE: {target}")
    domain = urlparse(target).netloc if 'http' in target else target
    if not domain: domain = target
    
    results = {
        "target": domain,
        "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
        "open_ports": [],
        "security_headers": {},
        "vulnerabilities": []
    }

    # 1. ðŸ” ESCANEO DE PUERTOS (SOCKET)
    print("   ðŸ” Escaneando puertos comunes...")
    for port, service in COMMON_PORTS.items():
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(0.5)
        result = sock.connect_ex((domain, port))
        if result == 0:
            print(f"      [!] PUERTO ABIERTO: {port} ({service})")
            results["open_ports"].append({"port": port, "service": service})
        sock.close()

    # 2. ðŸ›¡ï¸ ANÃLISIS DE CABECERAS HTTP
    print("   ðŸ›¡ï¸ Analizando blindaje HTTP...")
    try:
        url = f"https://{domain}" if not domain.startswith('http') else domain
        response = requests.get(url, timeout=5)
        headers = response.headers
        
        for header in SECURITY_HEADERS:
            if header in headers:
                results["security_headers"][header] = "âœ… CONFIGURADO"
            else:
                results["security_headers"][header] = "âŒ FALTANTE"
                results["vulnerabilities"].append(f"Falta cabecera de seguridad: {header}")
                
        server = headers.get('Server', 'Unknown')
        if server != 'Unknown':
            results["vulnerabilities"].append(f"InformaciÃ³n del servidor expuesta: {server}")

    except Exception as e:
        print(f"      [!] Error en anÃ¡lisis HTTP: {str(e)}")

    # 3. âš–ï¸ VERDICTO FINAL
    score = 100 - (len(results["open_ports"]) * 10) - (len(results["vulnerabilities"]) * 5)
    results["security_score"] = max(0, score)
    results["verdict"] = "ðŸ’Ž SEGURO" if score > 80 else "âš ï¸ RIESGO MEDIO" if score > 50 else "ðŸ’€ CRÃTICO"

    print("\nðŸ“Š REPORTE DE SEGURIDAD GENERADO:")
    print(json.dumps(results, indent=4, ensure_ascii=False))
    
    # GUARDAR
    filename = f"pentest_report_{domain}.json"
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(results, f, indent=4, ensure_ascii=False)
    
    return results

if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "google.com"
    scan_security(target)
