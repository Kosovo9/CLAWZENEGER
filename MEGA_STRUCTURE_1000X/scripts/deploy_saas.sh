#!/bin/bash

# ü¶Å SAAS BUILDER DEPLOYMENT SCRIPT (1000X)
# Autor: Huzeneger Omni-OS
# Descripci√≥n: Toma un proyecto generado por el Agente Coder y lo despliega en Docker localmente.

PROJECT_NAME=$1
PROJECT_PATH="./generated_saas/$PROJECT_NAME"

echo "üöÄ [SAAS BUILDER] INICIANDO DESPLIEGUE AUTOM√ÅTICO: $PROJECT_NAME"

# 1. VALIDACI√ìN
if [ -z "$PROJECT_NAME" ]; then
    echo "‚ùå Error: Debes especificar el nombre del proyecto."
    echo "Uso: ./deploy_saas.sh mi-nuevo-crm"
    exit 1
fi

if [ ! -d "$PROJECT_PATH" ]; then
    echo "‚ö†Ô∏è  El proyecto no existe. Creando estructura base..."
    mkdir -p "$PROJECT_PATH"
    
    # Crear HTML b√°sico de placeholder
    echo "<h1>üöÄ $PROJECT_NAME IS LIVE!</h1><p>Generated by Huzeneger Omni-OS</p>" > "$PROJECT_PATH/index.html"
    
    # Crear Dockerfile b√°sico (Nginx)
    echo "FROM nginx:alpine" > "$PROJECT_PATH/Dockerfile"
    echo "COPY . /usr/share/nginx/html" >> "$PROJECT_PATH/Dockerfile"
fi

# 2. CONSTRUCCI√ìN DOCKER
echo "üèóÔ∏è  Construyendo contenedor Docker..."
cd "$PROJECT_PATH" || exit
docker build -t "saas-$PROJECT_NAME" .

# 3. DESPLIEGUE
echo "‚ö° Desplegando en puerto aleatorio (8000-9000)..."
PORT=$(shuf -i 8000-9000 -n 1)

# Detener si ya existe
docker rm -f "saas-$PROJECT_NAME" 2>/dev/null || true

# Correr
docker run -d --name "saas-$PROJECT_NAME" -p "$PORT:80" "saas-$PROJECT_NAME"

echo ""
echo "‚úÖ SAAS DESPLEGADO CON √âXITO!"
echo "üåê URL: http://localhost:$PORT"
echo "üìÇ Path: $PROJECT_PATH"
echo "ü¶Å STATUS: ONLINE (Docker Container: saas-$PROJECT_NAME)"
